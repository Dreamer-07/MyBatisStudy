# 第一章 Mybatis 简介

## 1.1 使用工具(不使用)

> 工具：一些功能的简单封装

- 原生 JDBC -> dbUtils(QueryRunner) -> JdvcTemplate(Spring)
- ![image-20200908141149301](C:\Users\Admin\AppData\Roaming\Typora\typora-user-images\image-20200908141149301.png)
- 不使用原生 JDBC：
  1. 操作过程太过繁琐
  2. 会导致 数据库层 在程序中和 java 源代码的耦合程度太高



## 1.2 Hibernate - ORM框架

> ORM：对象关系映射

- 优点：只需要创建好对于的 JavaBean 后使用对应的注解，就可以完成数据库操作
- 大部分是黑箱操作
  ![image-20200908141823648](C:\Users\Admin\AppData\Roaming\Typora\typora-user-images\image-20200908141823648.png)
- 缺点
  - 无法轻松的完成定制 sql
  - 如果想快的完成定制 sql。还需要学习 HQL
  - 全映射框架，对于部分字段映射需要繁琐的操作才可以



## 1.3 MyBatis - 持久化层框架（SQL 映射框架）

- 只需要编写核心的 sql 语句即可
  ![image-20200908142901167](C:\Users\Admin\AppData\Roaming\Typora\typora-user-images\image-20200908142901167.png)
  
- 优点
  1. MyBatis 可以将重要的步骤( sql 语句) 抽取出来人工定制，其他步骤自动化
  2. 可以将 重要的步骤( sql 语句) 写在配置文件中 - 方便维护
  3. 完全解决数据库优化问题
  4. Mybatis 底层就是对原生 JDBC 的一个简单封装
  5. 可以将 sql 语句和 Java 编码解耦，同时不会失去自动化功能 - 半自动化的持久化层框架
  6. 一个轻量级框架
  
  
  
- **官方中文文档**：https://mybatis.org/mybatis-3/zh/getting-started.html



# 第二章 Mybatis × HelloWorld

## 2.1 核心步骤 

1. 创建工程，数据库数据表，对应的 JavaBean

2. 创建对应的 DAO 接口

3. 导入需要的依赖 / jar 包

   ```xml
   <!-- Mybatis依赖 -->
   <dependency>
       <groupId>org.mybatis</groupId>
       <artifactId>mybatis</artifactId>
       <version>3.4.1</version>
   </dependency>
   
   <!--  mysql数据库链接驱动-->
   <dependency>
       <groupId>mysql</groupId>
       <artifactId>mysql-connector-java</artifactId>
       <version>8.0.16</version>
   </dependency>
   
   <!--  建议导入Log4j2日志框架，可以查看相关日志 -->
   <dependency>
       <groupId>org.apache.logging.log4j</groupId>
       <artifactId>log4j-core</artifactId>
       <version>2.12.1</version>
   </dependency>
   <dependency>
       <groupId>org.apache.logging.log4j</groupId>
       <artifactId>log4j-api</artifactId>
       <version>2.12.1</version>
   </dependency>
   ```

4. 如果导入了 日志框架Log4J2,需要编写一个 log4j2.xml 的配置文件在程序中(任意位置)

   ```xml
   <?xml version="1.0" encoding="UTF-8"?>
   <!--日志级别以及优先级排序: OFF > FATAL > ERROR > WARN > INFO > DEBUG > TRACE > ALL -->
   <!--Configuration后面的status用于设置log4j2自身内部的信息输出，可以不设置，当设置成trace时，可以看到log4j2内部各种详细输出-->
   <configuration status="INFO">
       <!--先定义所有的appender-->
       <appenders>
           <!--输出日志信息到控制台-->
           <console name="Console" target="SYSTEM_OUT">
               <!--控制日志输出的格式-->
               <PatternLayout pattern="%d{yyyy-MM-dd HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n"/>
           </console>
       </appenders>
       <!--然后定义logger，只有定义了logger并引入的appender，appender才会生效-->
       <!--root：用于指定项目的根日志，如果没有单独指定Logger，则会使用root作为默认的日志输出-->
       <loggers>
           <root level="info">
               <appender-ref ref="Console"/>
           </root>
       </loggers>
   </configuration>
   ```

5. 写配置文件

   1. 编写 MyBatis 全局配置文件.xml  - 指导 mybatis 运行的

      ```xml
      <?xml version="1.0" encoding="UTF-8" ?>
      <!DOCTYPE configuration
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-config.dtd">
      <configuration>
        <environments default="development">
          <environment id="development">
            <transactionManager type="JDBC"/>
            <!-- 配置连接池 -->
            <dataSource type="POOLED">
              <!-- 配置连接数据库的四个基本信息 -->
              <property name="driver" value="${driver}"/>
              <property name="url" value="${url}"/>
              <property name="username" value="${username}"/>
              <property name="password" value="${password}"/>
            </dataSource>
          </environment>
        </environments>
        <mappers>
          <mapper resource="org/mybatis/example/BlogMapper.xml"/>
        </mappers>
      </configuration>
      ```

   2. 为一个 Dao 接口配置一个 xml 文件，该配置文件用来作为该接口的实现类 - 描述dao接口中的各个方法是如何工作的

      ```xml
      <?xml version="1.0" encoding="UTF-8" ?>
      <!DOCTYPE mapper
              PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
              "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
      <!--
      mapper标签通过 namespaces 属性用来指定需要实现的接口 DAO(全类名)
      -->
      <mapper namespace="pers.dreamer07.dao.EmployeeDao">
          <!--
          select标签代表该对应的实现方法是一个查询方法
              id = 实现的方法名
              resultType = 该方法的返回值类型(全类名)
          -->
          <!--
          在其内部完成 定制 sql 语句
              #{参数名}代表指定位置的数据 由 相同名称的参数名 填充
          -->
          <select id="getEmpById" resultType="pers.dreamer07.bean.Employee">
              select * from employee where id = #{id}
          </select>
      </mapper>
      ```

   3. 我们写的 dao 接口的实现文件，mybatis默认是不知道的，需要在**全局配置文件**添加以下配置

      ```xml
      <!-- 在该标签中指定我们编写的实现文件 -->
      <mappers>
          <!-- resource：从类路径出发 -->
          <mapper resource="mybatis_conf/EmployeeDao.xml"/>
      </mappers>
      ```

   

6. 设计测试类和方法

   ```java
   @Test
   public void testGetEmpById() throws IOException {
       /*
       1. 根据全局配置文件生成一个 SqlSessionFactory 类对象
       	SqlSessionFactory - 负责创建 SqlSession 类对象的一个工厂
       	SqlSession - sql会话，代表一次和数据库的连接
       * */
       String resource = "mybatis_conf/mybatis-config";
       InputStream inputStream = Resources.getResourceAsStream(resource);
       SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);
   
       SqlSession sqlSession = null;
       try {
           /*
           * 2. 根据 SqlSessionFactory 创建 SqlSession sql会话对象
           *       - 相当于 getConnection
           * */
           sqlSession = sqlSessionFactory.openSession();
   
           //3. 使用 sqlSession 操作数据库，获取对应的 Dao 接口实现类
           EmployeeDao employeeDao = sqlSession.getMapper(EmployeeDao.class);
   
           //4. 执行对应的方法
           System.out.println(employeeDao.getEmpById(1));
       } finally {
           if (sqlSession != null) {
               sqlSession.close();
           }
       }
   }
   ```

## 2.2 Mybatis_CRUD

1. 重新设计 EmployeeDao

   ```java
   //定义操作 Employee 表的规范
   public interface EmployeeDao {
   
       //根据id返回Emp对象
       public Employee getEmpById(Integer id);
   
       //添加 Emp 对象,返回 int影响行数
       public int addEmp(Employee employee);
   
       //根据id删除 Emp 对象
       public int deleteEmpById(Integer id);
   
       //修改Emp对象对应的数据库数据，为修改成功返回false(影响行数为0)，修改成功返回true(影响函数大于0)
       public boolean updateEmp(Employee employee);
   }
   ```

2. 在对应的 实现文件 EmployeeDao.xml 中实现对应的方法
   针对于 增删改 的实现方法会有些特殊，详情请看注解

   ```xml
   <?xml version="1.0" encoding="UTF-8" ?>
   <!DOCTYPE mapper
           PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
           "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
   <mapper namespace="pers.dreamer07.dao.EmployeeDao">
   
       <!--
       添加 Emp 对象,返回 int影响行数
           - public int addEmp(Employee employee);
           - 对于 增删改 语句不需要写返回类型 returnType 属性，mybatis会自动识别方法的返回值类型
               - 如果返回值类型是 int，就自动返回影响函数
               - 如果返回值类型是 boolean，就返回是否影响了0行以上的数据(0行就返回false，0行以上返回 true)
           - 如果方法接收一个对象类型的形参，在填充占位符时可以直接写上该形参的属性名
       -->
       <insert id="addEmp">
           INSERT INTO employee(empname,email,gender) VALUES(#{empName},#{email},#{gender})
       </insert>
   
       <!--
       根据id删除 Emp 对象
           - public int deleteEmpById(Integer id);
       -->
       <delete id="deleteEmpById">
           DELETE FROM employee WHERE id = #{id}
       </delete>
   
       <!--
       修改Emp对象对应的数据库数据，为修改成功返回false(影响行数为0)，修改成功返回true(影响函数大于0)
           - public boolean updateEmp(Employee employee);
       -->
       <update id="updateEmp">
           UPDATE employee SET empname = #{empName},email = #{email},gender = #{gender} WHERE id = #{id}
       </update>
   
       <!--
       根据id返回Emp对象
            - public Employee getEmpById(Integer id);
       -->
       <select id="getEmpById" resultType="pers.dreamer07.bean.Employee">
           SELECT * FROM employee WHERE id = #{id}
       </select>
   </mapper>
   ```

3. 重新设计测试类和测试方法

   ```java
   public class EmployeeDaoTest {
   
       private SqlSessionFactory sqlSessionFactory = null;
   
       @Before //作为Junit单元测试先行方法执行，初始化 SqlSessionFactory 对象
       public void initSqlSessionFactory() throws IOException {
           /*
           1. 根据全局配置文件生成一个 SqlSessionFactory 类对象
               SqlSessionFactory - 负责创建 SqlSession 类对象的一个工厂
               SqlSession - sql会话，代表一次和数据库的连接
           * */
           String resource = "mybatis_conf/mybatis-config";
           InputStream inputStream = Resources.getResourceAsStream(resource);
           sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);
       }
   
       @Test //测试添加方法
       public void testInsert(){
           SqlSession sqlSession = null;
           try {
           	/*
           	1. 获取 sqlSession 会话对象
               	- 传入一个布尔值，代表是否开始自动提交事务，默认为false，需要手动提交
            	*/
               sqlSession = sqlSessionFactory.openSession(true);
               //2. 获取对应的 Dao 实现类
               EmployeeDao employeeDao = sqlSession.getMapper(EmployeeDao.class);
               //3. 执行方法
               employeeDao.addEmp(new Employee(null,"EMT!!!","EMT@emt.com",1));
           } finally {
               //4. 关闭连接
               if (sqlSession != null) {
                   sqlSession.close();
               }
           }
       }
   
       @Test //测试删除方法
       public void testDelete(){
           SqlSession sqlSession = null;
           try {
           	/*
           	1. 获取 sqlSession 会话对象
               	- 传入一个布尔值，代表是否开始自动提交事务，默认为false，需要手动提交
            	*/
               sqlSession = sqlSessionFactory.openSession(true);
               //2. 获取对应的 Dao 实现类
               EmployeeDao employeeDao = sqlSession.getMapper(EmployeeDao.class);
               //3. 执行方法
               int i = employeeDao.deleteEmpById(2);
               System.out.println("影响行数：" + i);
           } finally {
               //4. 关闭连接
               if (sqlSession != null) {
                   sqlSession.close();
               }
           }
       }
   
       @Test //测试修改方法
       public void testUpdate(){
           SqlSession sqlSession = null;
           try {
           	/*
           	1. 获取 sqlSession 会话对象
               	- 传入一个布尔值，代表是否开始自动提交事务，默认为false，需要手动提交
            	*/
               sqlSession = sqlSessionFactory.openSession(true);
               //2. 获取对应的 Dao 实现类
               EmployeeDao employeeDao = sqlSession.getMapper(EmployeeDao.class);
               //3. 执行方法
               boolean b = employeeDao.updateEmp(new Employee(1, "EMT!", "emt@qq.com", null));
               if (b){
                   System.out.println("修改成功");
               }else{
                   System.out.println("修改失败");
               }
           } finally {
               //4. 关闭连接
               if (sqlSession != null) {
                   sqlSession.close();
               }
           }
       }
   
       @Test
       public void testSelect(){
           SqlSession sqlSession = null;
           try {
           	/*
           	1. 获取 sqlSession 会话对象
               	- 传入一个布尔值，代表是否开始自动提交事务，默认为false，需要手动提交
            	*/
               sqlSession = sqlSessionFactory.openSession(true);
               //2. 获取对应的 Dao 实现类
               EmployeeDao employeeDao = sqlSession.getMapper(EmployeeDao.class);
               //3. 执行方法
               Employee employee = employeeDao.getEmpById(1);
               System.out.println(employee);
           } finally {
               //4. 关闭连接
               if (sqlSession != null) {
                   sqlSession.close();
               }
           }
       }
   
   }
   ```

   

## 2.3 配置文件概述

- 两个配置文件
  1. 全局配置文件：mybatis-config.xml 负责指导 MyBatis 正确运行的一些全局设置
  2. SQL映射文件：EmployeeDao.xml 相当于对指定 Dao 接口的一个实现描述
- 补充细节
  - 通过 SqlSession.getMapper() 获取的对象，是指定接口的代理对象，是由 MyBatis 自动创建的
  - SqlSessionFactroy 和 SqlSession
    - SqlSessionFactroy 负责创建 SqlSession 类对象
    - SqlSession 相当于 Connection，是负责和数据库进行交互的一次会话



# 第三章 全局配置文件

## 3.1 说明

- 入门实例

  ```xml
  <?xml version="1.0" encoding="UTF-8" ?>
  <!DOCTYPE configuration
          PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
          "http://mybatis.org/dtd/mybatis-3-config.dtd">
  <configuration>
      <environments default="development">
          <environment id="development">
              <transactionManager type="JDBC"/>
              <!-- 配置连接池 -->
              <dataSource type="POOLED">
                  <!-- 配置连接数据库的四个基本信息 -->
                  <property name="driver" value="com.mysql.cj.jdbc.Driver"/>
                  <property name="url" value="jdbc:mysql:///mybatis_study?serverTimezone=UTC"/>
                  <property name="username" value="root"/>
                  <property name="password" value="Dreamer07"/>
              </dataSource>
          </environment>
      </environments>
  
      <!-- 在该标签中指定我们编写的实现文件 -->
      <mappers>
          <!-- resource：从类路径出发 -->
          <mapper resource="mybatis_conf/EmployeeDao.xml"/>
      </mappers>
  </configuration>
  ```

  - 可以参看官方文档：https://mybatis.org/mybatis-3/zh/configuration.html



- 配置文件中可以使用的标签 
  - configuration（配置）
    - [properties（属性）](https://mybatis.org/mybatis-3/zh/configuration.html#properties)
    - [**settings（设置）**](https://mybatis.org/mybatis-3/zh/configuration.html#settings)
    - [typeAliases（类型别名）](https://mybatis.org/mybatis-3/zh/configuration.html#typeAliases)
    - [typeHandlers（类型处理器）](https://mybatis.org/mybatis-3/zh/configuration.html#typeHandlers)
    - [objectFactory（对象工厂）](https://mybatis.org/mybatis-3/zh/configuration.html#objectFactory)
    - [plugins（插件）](https://mybatis.org/mybatis-3/zh/configuration.html#plugins)
    - environments（环境配置）
      - environment（环境变量）
        - transactionManager（事务管理器）
        - dataSource（数据源）
    - [databaseIdProvider（数据库厂商标识）](https://mybatis.org/mybatis-3/zh/configuration.html#databaseIdProvider)
    - [mappers（映射器）](https://mybatis.org/mybatis-3/zh/configuration.html#mappers)
  
  
  
- 配置文件中的标签是需要按一定顺序来的
  ![image-20200909145258160](C:\Users\Admin\AppData\Roaming\Typora\typora-user-images\image-20200909145258160.png)

## 3.2 常用标签

### 3.2.1 properties

- 作用：可以引入外部 properties 文件，且可以通过 {} 获取对应的key的value值

- 代码实例

  ```xml
  <?xml version="1.0" encoding="UTF-8" ?>
  <!DOCTYPE configuration
          PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
          "http://mybatis.org/dtd/mybatis-3-config.dtd">
  <configuration>
  
      <!--
      1. properties 标签的使用
          - 作用：引入外部资源文件
          - 属性
              - resource:从类路径下出发寻找资源
              - url:从磁盘/网络上寻找资源
          - 使用：使用${key}的方式获取对应的value值
      -->
      <properties resource="jdbc.properties"></properties>
  
      <environments default="development">
          <environment id="development">
              <transactionManager type="JDBC"/>
              <!-- 配置连接池 -->
              <dataSource type="POOLED">
                  <!-- 配置连接数据库的四个基本信息 -->
                  <property name="driver" value="${driverClass}"/>
                  <property name="url" value="${url}"/>
                  <property name="username" value="${username}"/>
                  <property name="password" value="${password}"/>
              </dataSource>
          </environment>
      </environments>
  
      <mappers>
          <mapper resource="mybatis_conf/EmployeeDao"></mapper>
      </mappers>
  </configuration>
  ```

  - jdbc.properties

    ```properties
    username=root
    password=Dreamer07
    url=jdbc:mysql:///mybatis_study?serverTimezone=UTC
    driverClass=com.mysql.cj.jdbc.Driver
    ```



### 3.2.2  settings(重要)

- 作用：这是 MyBatis 中极为重要的调整设置，它们会改变 MyBatis 的运行时行为。 下表描述了设置中各项属性设置的含义、默认值等。

  | 设置名                           | 描述                                                         | 有效值                                                       | 默认值                                                |
  | :------------------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- | :---------------------------------------------------- |
  | cacheEnabled                     | 全局性地开启或关闭所有映射器配置文件中已配置的任何缓存。     | true \| false                                                | true                                                  |
  | lazyLoadingEnabled               | 延迟加载的全局开关。当开启时，所有关联对象都会延迟加载。 特定关联关系中可通过设置 `fetchType` 属性来覆盖该项的开关状态。 | true \| false                                                | false                                                 |
  | aggressiveLazyLoading            | 开启时，任一方法的调用都会加载该对象的所有延迟加载属性。 否则，每个延迟加载属性会按需加载（参考 `lazyLoadTriggerMethods`)。 | true \| false                                                | false （在 3.4.1 及之前的版本中默认为 true）          |
  | multipleResultSetsEnabled        | 是否允许单个语句返回多结果集（需要数据库驱动支持）。         | true \| false                                                | true                                                  |
  | useColumnLabel                   | 使用列标签代替列名。实际表现依赖于数据库驱动，具体可参考数据库驱动的相关文档，或通过对比测试来观察。 | true \| false                                                | true                                                  |
  | useGeneratedKeys                 | 允许 JDBC 支持自动生成主键，需要数据库驱动支持。如果设置为 true，将强制使用自动生成主键。尽管一些数据库驱动不支持此特性，但仍可正常工作（如 Derby）。 | true \| false                                                | False                                                 |
  | autoMappingBehavior              | 指定 MyBatis 应如何自动映射列到字段或属性。 NONE 表示关闭自动映射；PARTIAL 只会自动映射没有定义嵌套结果映射的字段。 FULL 会自动映射任何复杂的结果集（无论是否嵌套）。 | NONE, PARTIAL, FULL                                          | PARTIAL                                               |
  | autoMappingUnknownColumnBehavior | 指定发现自动映射目标未知列（或未知属性类型）的行为。`NONE`: 不做任何反应`WARNING`: 输出警告日志（`'org.apache.ibatis.session.AutoMappingUnknownColumnBehavior'` 的日志等级必须设置为 `WARN`）`FAILING`: 映射失败 (抛出 `SqlSessionException`) | NONE, WARNING, FAILING                                       | NONE                                                  |
  | defaultExecutorType              | 配置默认的执行器。SIMPLE 就是普通的执行器；REUSE 执行器会重用预处理语句（PreparedStatement）； BATCH 执行器不仅重用语句还会执行批量更新。 | SIMPLE REUSE BATCH                                           | SIMPLE                                                |
  | defaultStatementTimeout          | 设置超时时间，它决定数据库驱动等待数据库响应的秒数。         | 任意正整数                                                   | 未设置 (null)                                         |
  | defaultFetchSize                 | 为驱动的结果集获取数量（fetchSize）设置一个建议值。此参数只可以在查询设置中被覆盖。 | 任意正整数                                                   | 未设置 (null)                                         |
  | defaultResultSetType             | 指定语句默认的滚动策略。（新增于 3.5.2）                     | FORWARD_ONLY \| SCROLL_SENSITIVE \| SCROLL_INSENSITIVE \| DEFAULT（等同于未设置） | 未设置 (null)                                         |
  | safeRowBoundsEnabled             | 是否允许在嵌套语句中使用分页（RowBounds）。如果允许使用则设置为 false。 | true \| false                                                | False                                                 |
  | safeResultHandlerEnabled         | 是否允许在嵌套语句中使用结果处理器（ResultHandler）。如果允许使用则设置为 false。 | true \| false                                                | True                                                  |
  | mapUnderscoreToCamelCase         | 是否开启驼峰命名自动映射，即从经典数据库列名 A_COLUMN 映射到经典 Java 属性名 aColumn。 | true \| false                                                | False                                                 |
  | localCacheScope                  | MyBatis 利用本地缓存机制（Local Cache）防止循环引用和加速重复的嵌套查询。 默认值为 SESSION，会缓存一个会话中执行的所有查询。 若设置值为 STATEMENT，本地缓存将仅用于执行语句，对相同 SqlSession 的不同查询将不会进行缓存。 | SESSION \| STATEMENT                                         | SESSION                                               |
  | jdbcTypeForNull                  | 当没有为参数指定特定的 JDBC 类型时，空值的默认 JDBC 类型。 某些数据库驱动需要指定列的 JDBC 类型，多数情况直接用一般类型即可，比如 NULL、VARCHAR 或 OTHER。 | JdbcType 常量，常用值：NULL、VARCHAR 或 OTHER。              | OTHER                                                 |
  | lazyLoadTriggerMethods           | 指定对象的哪些方法触发一次延迟加载。                         | 用逗号分隔的方法列表。                                       | equals,clone,hashCode,toString                        |
  | defaultScriptingLanguage         | 指定动态 SQL 生成使用的默认脚本语言。                        | 一个类型别名或全限定类名。                                   | org.apache.ibatis.scripting.xmltags.XMLLanguageDriver |
  | defaultEnumTypeHandler           | 指定 Enum 使用的默认 `TypeHandler` 。（新增于 3.4.5）        | 一个类型别名或全限定类名。                                   | org.apache.ibatis.type.EnumTypeHandler                |
  | callSettersOnNulls               | 指定当结果集中值为 null 的时候是否调用映射对象的 setter（map 对象时为 put）方法，这在依赖于 Map.keySet() 或 null 值进行初始化时比较有用。注意基本类型（int、boolean 等）是不能设置成 null 的。 | true \| false                                                | false                                                 |
  | returnInstanceForEmptyRow        | 当返回行的所有列都是空时，MyBatis默认返回 `null`。 当开启这个设置时，MyBatis会返回一个空实例。 请注意，它也适用于嵌套的结果集（如集合或关联）。（新增于 3.4.2） | true \| false                                                | false                                                 |
  | logPrefix                        | 指定 MyBatis 增加到日志名称的前缀。                          | 任何字符串                                                   | 未设置                                                |
  | logImpl                          | 指定 MyBatis 所用日志的具体实现，未指定时将自动查找。        | SLF4J \| LOG4J \| LOG4J2 \| JDK_LOGGING \| COMMONS_LOGGING \| STDOUT_LOGGING \| NO_LOGGING | 未设置                                                |
  | proxyFactory                     | 指定 Mybatis 创建可延迟加载对象所用到的代理工具。            | CGLIB \| JAVASSIST                                           | JAVASSIST （MyBatis 3.3 以上）                        |
  | vfsImpl                          | 指定 VFS 的实现                                              | 自定义 VFS 的实现的类全限定名，以逗号分隔。                  | 未设置                                                |
  | useActualParamName               | 允许使用方法签名中的名称作为语句参数名称。 为了使用该特性，你的项目必须采用 Java 8 编译，并且加上 `-parameters` 选项。（新增于 3.4.1） | true \| false                                                | true                                                  |
  | configurationFactory             | 指定一个提供 `Configuration` 实例的类。 这个被返回的 Configuration 实例用来加载被反序列化对象的延迟加载属性值。 这个类必须包含一个签名为`static Configuration getConfiguration()` 的方法。（新增于 3.2.3） | 一个类型别名或完全限定类名。                                 | 未设置                                                |
  | shrinkWhitespacesInSql           | Removes extra whitespace characters from the SQL. Note that this also affects literal strings in SQL. (Since 3.5.5) | true \| false                                                | false                                                 |

- 代码实例，这里以设置 mapUnderscoreToCamelCase 修改成 true 为例

  1. 重新设计数据库表，设置一个额外字段 xxx_xx 格式的字段
     <img src="C:\Users\Admin\AppData\Roaming\Typora\typora-user-images\image-20200909111913295.png" alt="image-20200909111913295" style="zoom: 80%;" />

  2. 在 xml 中使用对应的标签

     ```xml
     <?xml version="1.0" encoding="UTF-8" ?>
     <!DOCTYPE configuration
             PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
             "http://mybatis.org/dtd/mybatis-3-config.dtd">
     <configuration>
     
         <properties resource="jdbc.properties"></properties>
     
         <!--
         2. settings 标签的使用
              - 作用：这是 MyBatis 中极为重要的调整设置，它们会改变 MyBatis 的运行时行为
              - 属性：这里以设置 mapUnderscoreToCamelCase 属性为例
              - 使用：在内部定义 setting 标签，通过其 name 和 value 属性值
                     指定要修改的属性的对应的值
         -->
         <settings>
             <!--
             mapUnderscoreToCamelCase属性：是否开启 驼峰命名自动映射
                 可以将数据库列名 xxx_xxx，自动解析成 xxxXxxx 符合驼峰命名的字段
             -->
             <setting name="mapUnderscoreToCamelCase" value="true"/>
         </settings>
         
         <environments default="development">
             <environment id="development">
                 <transactionManager type="JDBC"/>
                 <!-- 配置连接池 -->
                 <dataSource type="POOLED">
                     <!-- 配置连接数据库的四个基本信息 -->
                     <property name="driver" value="${driverClass}"/>
                     <property name="url" value="${url}"/>
                     <property name="username" value="${username}"/>
                     <property name="password" value="${password}"/>
                 </dataSource>
             </environment>
         </environments>
     
         <mappers>
             <mapper resource="mybatis_conf/EmployeeDao"></mapper>
         </mappers>
     </configuration>
     ```
     
  3. 修改对应的 Bean 类，添加对应的 xxxXxx 属性
  
     ![image-20200909112222359](C:\Users\Admin\AppData\Roaming\Typora\typora-user-images\image-20200909112222359.png)
  
  4. 执行查询测试方法



### 3.2.3 typeAliases

- 作用：可以为常用的类起别名，使其在 SQL 映射文件中可以不写全类名

- 代码实例

  - 全局配置文件

    ```xml
    <?xml version="1.0" encoding="UTF-8" ?>
    <!DOCTYPE configuration
            PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
            "http://mybatis.org/dtd/mybatis-3-config.dtd">
    <configuration>
    
        <!--
        3. typeAliases
            - 作用：可以为常用的类起别名，使其在 SQL 映射文件中可以不写全类名
            - 使用：在内部定义 typeAlias 标签，通过 type 属性为对应的全类名起别名
        -->
        <typeAliases>
            <!--
            typeAlias 标签
                - 通过设置 type 属性指定对应的全类名，默认别名为类名(不区分大小写)
                - 可以通过设置 alias 属性设置指定的别名(使用时也不区分大小写)
            -->
            <!--        <typeAlias type="pers.dreamer07.bean.Employee" alias="emp"></typeAlias>-->
    
            <!--
            package 标签
                - 通过 name 属性值指定包名，为该包下的所有类起别名,默认别名都是类型(不区分大小写)
            -->
            <package name="pers.dreamer07"/>
        </typeAliases>
    
    </configuration>
    ```

  - SQL 映射文件 - EmployeeDao.xml

    ```xml
    <?xml version="1.0" encoding="UTF-8" ?>
    <!DOCTYPE mapper
            PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
            "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    <mapper namespace="pers.dreamer07.dao.EmployeeDao">
        <!--
        根据id返回Emp对象
             - public Employee getEmpById(Integer id);
             - 如果需要指定别名，需要在对应的类上加上 @Alias 注解指定
        -->
        <!-- resultType可以根据别名找到对应的类，而不用通过全类名 -->
        <select id="getEmpById" resultType="Emp">
            SELECT * FROM employee WHERE id = #{id}
        </select>
    </mapper>
    ```

  - 针对 批量起别名的情况，在对应的 bean 中还可以添加 @Alisa 注解
    ![image-20200909140358755](C:\Users\Admin\AppData\Roaming\Typora\typora-user-images\image-20200909140358755.png)

- 但开发中不建议起别名，因为使用全类名，能帮助我们更容易理解和查看代码

- MyBatis 中已经为一部分类型起了别名，注意自定义别名时不要冲突

  | 别名       | 映射的类型 |
  | :--------- | :--------- |
  | _byte      | byte       |
  | _long      | long       |
  | _short     | short      |
  | _int       | int        |
  | _integer   | int        |
  | _double    | double     |
  | _float     | float      |
  | _boolean   | boolean    |
  | string     | String     |
  | byte       | Byte       |
  | long       | Long       |
  | short      | Short      |
  | int        | Integer    |
  | integer    | Integer    |
  | double     | Double     |
  | float      | Float      |
  | boolean    | Boolean    |
  | date       | Date       |
  | decimal    | BigDecimal |
  | bigdecimal | BigDecimal |
  | object     | Object     |
  | map        | Map        |
  | hashmap    | HashMap    |
  | list       | List       |
  | arraylist  | ArrayList  |
  | collection | Collection |
  | iterator   | Iterator   |



### 3.2.4 typeHandlers 

- 作用：在 Mybatis 处理 预编译语句时设置一个参数 / 从结果集中取出一个值时
  都会使用类型处理器将获取的值以合适的方式转换为 Java 类型



### 3.2.5 plugins 插件

- MyBatis 四大对象
  <img src="C:\Users\Admin\AppData\Roaming\Typora\typora-user-images\image-20200909142743887.png" alt="image-20200909142743887" style="zoom:80%;" />
- 作用：可以通过插件修改 MyBatis 的核心行为，**插件通过动态代理机制**
  可以i介入四大对象的任何一个方法的执行



### 3.2.6 environments

- 作用：环境管理器，可以在内部通过 environment 标签配置多个环境

- 使用：

  - 可以通过修改 default 属性指定默认的环境id
  - 在内部定义 environment 标签 - 对应一个具体的环境
    - id属性为唯一标识
    - 在内部可以配置 数据源dataSource 和 事务管理器transactionManager

- 代码实例

  ```xml
  <?xml version="1.0" encoding="UTF-8" ?>
  <!DOCTYPE configuration
          PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
          "http://mybatis.org/dtd/mybatis-3-config.dtd">
  <configuration>
  
      <!--
      4，environments标签
          - 作用：环境管理器，可以在内部通过 environment 标签配置多个环境
              - 可以通过修改 default 属性指定默认的环境id
              - environment 标签 - 对应一个具体的环境配置
                  - id属性为唯一标识
                  - 在内部可以配置 数据源dataSource 和 事务管理器transactionManager
      -->
      <environments default="development">
          <environment id="development">
              <transactionManager type="JDBC"/>
              <!-- 配置数据源 -->
              <dataSource type="POOLED">
                  <!-- 配置连接数据库的四个基本信息 -->
                  <property name="driver" value="${driverClass}"/>
                  <property name="url" value="${url}"/>
                  <property name="username" value="${username}"/>
                  <property name="password" value="${password}"/>
              </dataSource>
          </environment>
      </environments>
  
      <mappers>
          <mapper resource="mybatis_conf/EmployeeDao"></mapper>
      </mappers>
  </configuration>
  ```

- 但在开发过程中，我们会更多的使用 **Spring 来配置事务管理器**
  使用 **德鲁伊数据库连接池** 配置数据源



### 3.2.7 databaseIdProvider

- 作用：mybatis 针对数据库移植性使用的标签
- 使用：
  - type属性固定为 DB_VENDOR
  - 在内部使用 property 标签指定数据库厂商和别名

- 代码实例
  (全局配置文件)

  ```xml
  <?xml version="1.0" encoding="UTF-8" ?>
  <!DOCTYPE configuration
          PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
          "http://mybatis.org/dtd/mybatis-3-config.dtd">
  <configuration>
      <environments default="development">
          <environment id="development">
              <transactionManager type="JDBC"/>
              <dataSource type="POOLED">
                  <property name="driver" value="${driverClass}"/>
                  <property name="url" value="${url}"/>
                  <property name="username" value="${username}"/>
                  <property name="password" value="${password}"/>
              </dataSource>
          </environment>
      </environments>
      
      <!--
      5. databaseIdProvider 标签
          作用：mybatis 针对数据库移植性使用的标签
          使用：
              - type属性固定为 DB_VENDOR
              - 在内部使用 property 标签指定数据库厂商和别名
      -->
      <databaseIdProvider type="DB_VENDOR">
          <!--
          property 标签
              使用：
                  - name 属性指定 数据库厂商白标识 [MySQL / Oracle / SQL Server]
                  - value 属性指定对应的别名
          -->
          <property name="MySQL" value="mysql"/>
          <property name="Oracle" value="orac"/>
          <property name="SQL Server" value="sqlserver"/>
      </databaseIdProvider>
  
      <mappers>
          <mapper resource="mybatis_conf/EmployeeDao"></mapper>
      </mappers>
  </configuration>
  ```
  

(SQL 映射文件)

```xml
  <?xml version="1.0" encoding="UTF-8" ?>
  <!DOCTYPE mapper
          PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
          "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="pers.dreamer07.dao.EmployeeDao">
  
      <!--
      根据id返回Emp对象
           - public Employee getEmpById(Integer id);
           - 如果需要指定别名，需要在对应的类上加上 @Alias 注解指定
      -->
      <select id="getEmpById" resultType="pers.dreamer07.bean.Employee">
          SELECT * FROM employee WHERE id = #{id}
      </select>
  
      <!--
      databaseId 属性指定配置的 数据库厂商标识的别名
          - 针对于 MyBatis 和不同数据库对接时，优先使用指定了 对应厂商标识 的语句
          - 如果没有对应厂商标识的语句，就使用给默认没有指定 databaseId 属性的语句
      -->
      <select id="getEmpById" resultType="pers.dreamer07.bean.Employee" databaseId="mysql">
          SELECT * FROM employee WHERE id = #{id}
      </select>
  
      <select id="getEmpById" resultType="pers.dreamer07.bean.Employee" databaseId="orac">
          SELECT * FROM employee WHERE id = #{id}
      </select>
  </mapper>
```



### 3.2.8 mappers

- 作用：负责管理 SQL 映射文件在 MyBatis 中的注册

- 使用：在内部定义 mapper / package 标签，通过该标签加载 SQL 映射文件

- 代码实例
  (全局配置文件)

  ```xml
  <?xml version="1.0" encoding="UTF-8" ?>
  <!DOCTYPE configuration
          PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
          "http://mybatis.org/dtd/mybatis-3-config.dtd">
  <configuration>
  
      <properties resource="jdbc.properties"></properties>
  
      <settings>
          <setting name="mapUnderscoreToCamelCase" value="true"/>
      </settings>
  
      <environments default="development">
          <environment id="development">
              <transactionManager type="JDBC"/>
              <!-- 配置数据源 -->
              <dataSource type="POOLED">
                  <!-- 配置连接数据库的四个基本信息 -->
                  <property name="driver" value="${driverClass}"/>
                  <property name="url" value="${url}"/>
                  <property name="username" value="${username}"/>
                  <property name="password" value="${password}"/>
              </dataSource>
          </environment>
      </environments>
  
      <!--
      6. mappers 标签
          - 作用：负责管理 SQL 映射文件在 MyBatis 中的注册
          - 使用：在内部定义 mapper 标签，通过该标签加载 SQL 映射文件
      -->
      <mappers>
          <!--
          mapper标签的使用
              1. resource(常用)：通过类路径加载 SQL 映射文件
              2. url：可以通过 网络 / 磁盘 加载 SQL 映射文件
              3. class：
                  3.1 用法一：指定全类名，要求时在该类的同路径下有一个同名的 SQL 映射文件
                  3.2 用法二：指定全类名：使用注解配置该接口
          -->
  <!--        <mapper resource="mybatis_conf/EmployeeDao.xml"/>-->
          <!--
  		package 标签的使用
  			1. 使用 name 属性值指定包的位置
  			2. 该包下的所有接口必须满足 mapper.class 属性的约束，才可以注册到 MyBatis 中
  				1. 在编译后的同目录下，有同名的 SQL 映射文件
  				2. 使用注解配置该接口
  		-->
          <package name="pers.dreamer07"/>
      </mappers>
  </configuration>
  ```

  (pers.dreamer07)
  ![image-20200910100402077](C:\Users\EMTKnight\AppData\Roaming\Typora\typora-user-images\image-20200910100402077.png)

  EmployeeDaoAnno  - 注解配置接口
  <img src="C:\Users\EMTKnight\AppData\Roaming\Typora\typora-user-images\image-20200910100458557.png" alt="image-20200910100458557" style="zoom:80%;" />

  **针对于Maven工程** ，需要在 pom.xml 中添加以下代码

  ```xml
   <build>
       <!--必须包含资源文件-->
       <resources>
           <resource>
               <directory>src/main/resources</directory>
               <includes>
                   <include>**/*.properties</include>
                   <include>**/*.xml</include>
               </includes>
           </resource>
           <resource>
               <directory>src/main/java</directory>
               <includes>
                   <include>**/*.properties</include>
                   <include>**/*.xml</include>
               </includes>
           </resource>
       </resources>
  </build>
  ```



# 第四章 SQL 映射文件

## 4.1 可以使用的标签

1. chche：与缓存相关
2. chche-ref：与缓存相关
3. parameterMap：**不使用**
4. resultMap:结果映射，自定义结果集的封装规则
5. sql：抽取可以重用的 sql
6. insert，delet，select。update ：增删查改



## 4.2 增删改标签的使用

- 常用属性
  <img src="C:\Users\EMTKnight\AppData\Roaming\Typora\typora-user-images\image-20200910104728242.png" alt="image-20200910104728242" style="zoom:80%;" />

### 4.2.1 获取插入数据后的自增主键id 

(SQL 映射文件)

```xml
<!--
获取自增id的值 - 使用 insert / update 标签中的 useGeneratedKeys 和  keyProperty 属性
    - useGeneratedKeys：底层调用原生 JDBC 中的方法获取添加数据后自增id的值
    - keyProperty：将获取的自增id的值，赋给 employee 对象中的对应的 属性
-->
<insert id="addEmp" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO employee(emp_name,email,gender) VALUES(#{empName},#{email},#{gender})
</insert>
```

(测试方法)

![image-20200910111759083](C:\Users\EMTKnight\AppData\Roaming\Typora\typora-user-images\image-20200910111759083.png)



### 4.2.2 获取非自增主键的值

(SQL 映射文件)

```xml
<!--
获取非自增主键 id 的值
    - 在内部使用 selectKey 标签
-->
<insert id="addEmp2" >
    <!--
    selectKey 标签
       - 作用：可以通过指定 order 属性，设置 BEFPRE / AFTER 可以使其在核心 sql 语句 之前/之后 执行
       - 使用：
            1. 设置 order 属性
            2. 设置 resultType 属性，指定返回值类型
            3. 设置 keyProperty 属性，将查询的返回值赋值给对应的属性
    -->
    <selectKey order="BEFORE" resultType="integer" keyProperty="id">
        SELECT MAX(id) + 1 FROM employee <!-- 对于没有自增id的主键，先查询出最大的主键id值，并将值+1后赋值给对于的属性，后再存入数据 -->
    </selectKey>
    INSERT INTO employee(id,emp_name,email,gender) VALUES(#{id},#{empName},#{email},#{gender})
</insert>
```

(测试方法)

<img src="C:\Users\EMTKnight\AppData\Roaming\Typora\typora-user-images\image-20200910194934047.png" alt="image-20200910194934047" style="zoom:80%;" />



## 4.3 参数的各种取值

1. 单个参数

   - 基本类型
     - 取值：#{随便写}
   - POJO - 看下面

2. 多个参数

   - 注意：无法通过 #{参数名} 获取对于的参数值

   - 取值：

     1. 使用对应的索引，从 0 开始，例如 #{0},#{1}
     2. 使用对应的标识：从 param1 开始，例如 #{param1},#{param2},#{paramN}

   - 原理：
     MyBatis 会将参数封装成一个 Map
     需要使用默认的 key(N / paramN)  来取出对应索引上的数据

   - 解决 - 命名参数

     在方法的定义中，为参数添加 @Param 注解，通过指定 value 值指定对应其在 **MyBatis中的 Key**

     ![image-20200910200453807](C:\Users\EMTKnight\AppData\Roaming\Typora\typora-user-images\image-20200910200453807.png)

3. Map

   - 取值：#{key}

4. POJO ( JavaBean )

   - 取值：#{属性名} / #{key.属性名}

## 4.4 取值方式

### 4.4.1 #{}

- 说明：参数预编译；对于的参数位置上都会使用 ? 代替，再通过设置预编译的方式将参数值传递进去；

  ​		    是安全的，不会由 sql 注入问题

- 使用：在需要参数预编译的位置上使用 #{} 取值

### 4.4.2 ${}

- 说明：不是参数预编译，而是直接使用对 sql 语句 进行拼串，不安全的，可能会有 sql 注入问题
- 使用：在不支持参数预编译的位置上使用 ${} 取值



## 4.5 取值时可以使用的规则

- 在我们使用 #{} 取值时可以指定部分规则来约束字段值和属性

  (官方文档)

  <img src="C:\Users\EMTKnight\AppData\Roaming\Typora\typora-user-images\image-20200911141048166.png" alt="image-20200911141048166" style="zoom: 200%;" />

- 最常用的属性时 jdbcType

  > JdbcType :  保存了 Java 类型和 数据类字段类型的映射关系，指定该字段的值在数据库中的字段类型
  - 说明：如果在参数取值时传入 null 值
    - Mysql 在字段允许为空的